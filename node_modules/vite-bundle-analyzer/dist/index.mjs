import{fileURLToPath as me}from"url";import fe from"path";var ye=()=>me(import.meta.url),ge=()=>fe.dirname(ye()),f=ge();import M from"path";import ae from"fs/promises";import le from"picocolors";var T="vite-bundle-analyzer";import $ from"os";import xe from"child_process";var be="microsoft";function ze(e){switch(e){case"linux":return $.release().toLocaleLowerCase().indexOf(be)!==-1?["win32","cmd.exe"]:["linux","xdg-open"];case"win32":return["win32","cmd.exe"];case"darwin":return["darwin","open"];default:return[e,"xdg-open"]}}function _(e){let[t,r]=ze($.platform());return t==="win32"&&(e=e.map(n=>n.replace(/[&^]/g,"^$&")),e=["/c","start",'""'].concat(e)),xe.spawn(r,e)}import q from"fs/promises";import X from"path";import K from"zlib";import Se from"util";import C from"fs";import v from"fs/promises";import k from"path";function H(e){let t=["Bytes","KB","MB","GB","TB"];if(!e)return"0 "+t[0];let r=parseInt(`${Math.floor(Math.log(e)/Math.log(1024))}`);return(e/(1<<r*10)).toFixed(2)+" "+t[r]}function w(e,t){return t.reduce((r,n)=>(r[n]=e[n],r),{})}var we=Se.promisify(K.gzip),ke={level:K.constants.Z_DEFAULT_LEVEL},x=A(k.join(f,"client")),Z=A(k.join(x,"assets"));function J(e={}){return e=Object.assign(ke,e),t=>we(t,e)}function A(e){return/^\\\\\?\\/.test(e)?e:e.replace(/\\/g,"/")}function N(e){return typeof e=="string"?new TextEncoder().encode(e):e}async function U(e){let t=await Promise.all((await v.readdir(e)).map(i=>k.join(e,i))),r=0,n=[];for(;r!==t.length;){let i=t[r],o=await v.stat(i);if(o.isDirectory()){let a=await v.readdir(i);t.push(...a.map(s=>k.join(i,s)))}o.isFile()&&n.push(i),r++}return n}function Ae(e){try{return C.statSync(e,{throwIfNoEntry:!1})}catch{}}function V(e){if(!Ae(e))return!1;try{return C.accessSync(e,C.constants.R_OK),!0}catch{return!1}}function P(e){let t=e.injectTo==="head"?/([ \t]*)<\/head>/i:/([ \t]*)<\/body>/i;e.descriptors=Array.isArray(e.descriptors)?e.descriptors:[e.descriptors];let r=e.descriptors.map(n=>`<${n.kind}>${n.text}</${n.kind}>`);return e.html.replace(t,n=>`${r.join(`
`)}${n}`)}function F(e,t){let{stringify:r}=JSON;return`window.defaultSizes = ${r(t)},window.foamModule = ${r(e)};`}async function Q(e,t){let r=await U(Z),i=(await Promise.all(r.map(async a=>{let s=X.extname(a).replace(".",""),c=await q.readFile(a,"utf8");return{fileType:s,content:c}}))).filter(a=>["js","css"].includes(a.fileType)),o=await q.readFile(X.join(x,"index.html"),"utf8");return o=o.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,""),o=o.replace(/<link\b[^>]*rel="stylesheet"[^>]*>/gi,""),o=o.replace(/<title>(.*?)<\/title>/,`<title>${t.title}</title>`),o=P({html:o,injectTo:"head",descriptors:i.map(({fileType:a,content:s})=>({kind:a==="js"?"script":"style",text:s}))}),o=P({html:o,injectTo:"body",descriptors:{kind:"script",text:F(e,t.mode)}}),o}import R from"fs";import b from"path";var Pe=["pnpm-workspace.yaml","lerna.json"];function Oe(e){let t=b.join(e,"package.json");if(!V(t))return!1;try{return!!(JSON.parse(R.readFileSync(t,"utf-8"))||{}).workspaces}catch{return!1}}function je(e){return Pe.some(t=>R.existsSync(b.join(e,t)))}function Me(e){let t=b.join(e,"package.json");return R.existsSync(t)}function Y(e,t=e){if(Me(e))return e;let r=b.dirname(e);return!r||r===e?t:Y(r,t)}function z(e,t=Y(e)){if(je(e)||Oe(e))return e;let r=b.dirname(e);return!r||r===e?t:z(r,t)}import S from"path";var O=class{kind;meta;filename;children;groups;isEndOfPath;constructor(t){this.kind=t?.kind||"stat",this.meta=t?.meta||{},this.filename=t?.filename||"",this.children=new Map,this.groups=[],this.isEndOfPath=!1}},B=class{root;constructor(t){this.root=new O(t)}insert(t,r){let n=this.root,i=t.split("/").filter(Boolean);for(let o of i)n.children.has(o)||n.children.set(o,Te({...r,filename:o})),n=n.children.get(o);n.isEndOfPath=!0}mergePrefixSingleDirectory(t=this.root){for(let[r,n]of t.children.entries()){if(n.isEndOfPath)break;if(n.children.size>1){this.mergePrefixSingleDirectory(n);continue}t.children.delete(r);for(let[i,o]of n.children.entries())t.children.set(`${r}/${i}`,o),o.isEndOfPath||this.mergePrefixSingleDirectory(o)}}walk(t,r){if(t.children.size){for(let[n,i]of t.children.entries()){let o={...i.meta,id:n,label:n,groups:i.groups};if(i.isEndOfPath&&delete o.groups,r(o,t),this.walk(i,r),o.groups&&o.groups.length)switch(t.kind){case"stat":o.statSize=o.groups.reduce((a,s)=>a+s.statSize,0);break;case"source":{let a=o.groups.reduce((s,c)=>(s.parsedSize+=c.parsedSize,s.gzipSize+=c.gzipSize,s),{parsedSize:0,gzipSize:0});Object.assign(o,a)}}}t.children.clear()}}};function Te(e){return new O(e)}function E(e){return new B(e)}import{SourceMapConsumer as I}from"source-map";var ve=new TextDecoder;async function ee(e){let t=await new I(e),n=(await t.sources).reduce((i,o)=>{let a=t.sourceContentFor(o,!0);return a&&i.push({id:o,code:a}),i},[]);return t.destroy(),n}function Ce(e){let t=[],r=0;for(let n=0;n<e.length;n++)if(e[n]===10){let i=e.subarray(r,n);t.push(i),r=n+1}return r<e.length&&t.push(e.subarray(r)),t}function Ne(e,t){let r=t.reduce((i,o)=>{let{generatedLine:a}=o;return a in i||(i[a]=[]),i[a].push(o),i},{}),n="";for(let i in r){let o=parseInt(i)-1;if(e[o]){let a=ve.decode(e[o]),s=r[i],c=s.length;for(let l=0;l<c;l++){let p=s[l],d=l+1>=c?null:s[l+1];if(c===1||p.lastGeneratedColumn===null){n+=a.substring(p.generatedColumn);continue}if(typeof p.lastGeneratedColumn=="number"){let y=p.lastGeneratedColumn+1===d?.generatedColumn?d.generatedColumn:p.lastGeneratedColumn;n+=a.substring(p.generatedColumn,y)}}}}return n}async function te(e,t,r){let n={},i=Ce(e),o=await new I(t),a=Object.create(null);o.eachMapping(s=>{if(s.source){let c=r(s.source);c in a||(a[c]={mappings:[]}),a[c].mappings.push(s)}},null,I.ORIGINAL_ORDER);for(let s in a){let{mappings:c}=a[s];c.sort((l,p)=>l.generatedColumn-p.generatedColumn),c.length>0&&(n[s]=Ne(i,c))}return o.destroy(),n}var re=[".mjs",".js",".cjs",".ts",".tsx",".vue",".svelte",".md",".mdx"],ne=process.cwd(),Fe=new TextEncoder;function Re(e,t=ne){return e=A(e),e.replace(t,"").replace(/\0/,"")}function j(e,t=ne){let r=Re(e,t);return S.isAbsolute(r)?r.replace("/",""):r}function Be(e,t,r){if(t in r)return r[t].source;throw new Error(`[analyzer error]: Missing sourcemap for ${e}.`)}function Ee(e,t,r){let n={},i=e.type==="chunk";return n.code=N(i?e.code:e.source),n.map=Be(e.fileName,r,t),n.imports=i?e.imports:[],n.dynamicImports=i?e.dynamicImports:[],n.moduleIds=i?e.moduleIds:[],n.filename=e.fileName,n.isEntry=i?e.isEntry:!1,n}var L=class{originalId;id;label;parsedSize;mapSize;statSize;gzipSize;source;stats;imports;isAsset;isEntry;constructor(t,r){this.originalId=r,this.id=r,this.label=r,this.parsedSize=0,this.statSize=0,this.gzipSize=0,this.mapSize=0,this.source=[],this.stats=[],this.imports=new Set,this.isAsset=!0,this.isEntry=!1}addImports(...t){t.forEach(r=>this.imports.add(r))}async setup(t,r,n,i){let{imports:o,dynamicImports:a,map:s,moduleIds:c}=t;this.addImports(...o,...a),this.mapSize=s.length,this.isEntry=t.isEntry;let l=c.length?c.reduce((u,m)=>{let g=r.getModuleInfo(m);return g&&g.code&&(re.includes(S.extname(g.id))||g.id.startsWith("\0"))&&u.push({id:g.id,code:g.code}),u},[]):await ee(s),p=E({meta:{statSize:0}}),d=E({kind:"source",meta:{gzipSize:0,parsedSize:0}});for(let u of l){if(u.id[0]==="."){let g=await r.resolve(u.id,this.originalId);if(!g)continue;u.id=g.id}let m=Fe.encode(u.code).byteLength;this.statSize+=m,p.insert(j(u.id,i),{kind:"stat",meta:{statSize:m}})}let y=await te(t.code,s,u=>{let m=S.relative(i,u);return S.join(i,m)});for(let u in y){if(!re.includes(S.extname(u)))continue;let m=y[u],g=N(m),{byteLength:ue}=await n(g),de=g.byteLength;d.insert(j(u,i),{kind:"source",meta:{gzipSize:ue,parsedSize:de}})}p.mergePrefixSingleDirectory(),p.walk(p.root,(u,m)=>m.groups.push(u)),d.mergePrefixSingleDirectory(),d.walk(d.root,(u,m)=>m.groups.push(u)),this.stats=p.root.groups,this.source=d.root.groups;for(let u of this.source)this.gzipSize+=u.gzipSize,this.parsedSize+=u.parsedSize}};function Ie(e){return new L(j(e),e)}var W=class{compress;modules;workspaceRoot;pluginContext;chunks;constructor(t){this.compress=J(t),this.modules=[],this.pluginContext=null,this.chunks={},this.workspaceRoot=process.cwd()}installPluginContext(t){this.pluginContext||(this.pluginContext=t)}setupRollupChunks(t){this.chunks=t}async addModule(t,r){let n=Ee(t,this.chunks,r),i=Ie(n.filename);await i.setup(n,this.pluginContext,this.compress,this.workspaceRoot),this.modules.push(i)}processFoamModule(){let r=(n=>{let i=(o,a=[])=>{let s=[...o.imports].flatMap(l=>this.modules.filter(p=>!a.includes(p.id)&&p.id===j(l))),c=s.map(l=>l.id).concat(a);return s.flatMap(l=>i(l,c)).concat(s)};return n.filter(o=>o.isEntry).reduce((o,a)=>(i(a).forEach(s=>{o[s.id]||(o[s.id]=new Set),o[s.id].add(a.id)}),o),{})})(this.modules);return this.modules.map(n=>({...w(n,["id","label","statSize","parsedSize","mapSize","gzipSize","source","stats","isAsset","isEntry"]),imports:Array.from(r[n.id]??[])}))}};function ie(e){return new W(e)}import Le from"http";import oe from"fs";import D from"path";var We={".js":"application/javascript",".css":"text/css"};function De(e,t){let r=new Map;return function(i,o){let a=D.join(x,i.url);if(r.has(a)){let{data:s,mimeType:c}=r.get(a);o.writeHead(200,{"Content-Type":c}),o.end(s);return}if(i.url==="/"){o.setHeader("Content-Type","text/html; charset=utf8;");let s=oe.readFileSync(D.join(x,"index.html"),"utf8");s=s.replace(/<title>(.*?)<\/title>/,`<title>${e.title}</title>`),s=P({html:s,injectTo:"body",descriptors:{kind:"script",text:F(t,e.mode)}}),o.end(s),r.set(a,{data:s,mimeType:"text/html; charset=utf8;"});return}oe.readFile(a,(s,c)=>{if(s)o.statusCode=404,o.end("Not Found");else{let l=D.extname(a),p=We[l]||"application/octet-stream";o.writeHead(200,{"Content-Type":p}),o.end(c),r.set(a,{data:c,mimeType:p})}})}}function se(e=0){let t=Le.createServer();return t.listen(e,()=>{console.log(`server run on http://localhost:${t.address().port}`)}),{setup:(n,i)=>{t.on("request",De(i,n))},get port(){return t.address().port}}}function Ge(e){let t=w(e,["name","generateBundle","closeBundle","api"]),r=process.cwd(),{store:n}=t.api;return{...t,outputOptions(i){return i.dir&&(r=i.dir),n.analyzerModule.workspaceRoot=z(r),"sourcemap"in i&&(n.previousSourcemapOption=typeof i.sourcemap=="boolean"?i.sourcemap:i.sourcemap==="hidden"),typeof i.sourcemap=="boolean"&&i.sourcemap?i.sourcemap=!0:i.sourcemap="hidden",i}}}var $e=!!process.env.CI;function _e(e){_([e])}var ce=e=>le.dim(le.bold(e)),G=e=>ce(H(e)),pe=e=>{let t=e.length,r=e.reduce((i,o)=>(i.gzip+=o.gzipSize,i.parsed+=o.parsedSize,i.map+=o.mapSize,i),{gzip:0,parsed:0,map:0}),n=[r.gzip&&`gzip: ${G(r.gzip)}`,r.map&&`map: ${G(r.map)}`].filter(Boolean).join(" | ");return`${ce(t)} chunks of ${G(r.parsed)} ${n?`(${n})`:""}`};function He(e,t){let{type:r}=e;if(r==="asset"&&M.extname(e.fileName)===".js"){let i=e.fileName+".map";return i in t?[!0,i]:[!0,null]}let n=r==="chunk";return[n,n?e.sourcemapFileName:null]}function Qt(e={analyzerMode:"server",summary:!0}){let{reportTitle:t=T}=e,r=ie(e?.gzipOptions),n={previousSourcemapOption:!1,analyzerModule:r},i=process.cwd(),o=!0,a,s=process.cwd();return{name:T,apply:"build",enforce:"post",api:{store:n},configResolved(l){if(i=M.resolve(l.root,l.build.outDir??""),a=l.logger,s=z(l.root),r.workspaceRoot=s,e.summary){let p=l.plugins.find(d=>d.name==="vite:reporter");if(o=!!p?.writeBundle,p?.writeBundle){let d=typeof p.writeBundle=="function"?p.writeBundle:p.writeBundle?.handler,y=async function(...u){await d?.apply(this,u),a.info(pe(r.modules))};typeof p.writeBundle!="function"?p.writeBundle.handler=y:p.writeBundle=y}}},config(l){l.build?.sourcemap&&(n.previousSourcemapOption=typeof l.build.sourcemap=="boolean"?l.build.sourcemap:l.build.sourcemap==="hidden"),l.build||(l.build={}),typeof l.build.sourcemap=="boolean"&&l.build.sourcemap?l.build.sourcemap=!0:l.build.sourcemap="hidden"},async generateBundle(l,p){r.installPluginContext(this),r.setupRollupChunks(p);for(let d in p){let y=p[d],[u,m]=He(y,p);u&&m&&await r.addModule(y,m),n.previousSourcemapOption||u&&m&&Reflect.deleteProperty(p,m)}},async closeBundle(){switch(e.summary&&!o&&a.info(pe(r.modules)),e.analyzerMode){case"json":{let l=M.join(i,e.fileName?`${e.fileName}.json`:"stats.json"),p=r.processFoamModule();return ae.writeFile(l,JSON.stringify(p,null,2),"utf8")}case"static":{let l=M.join(i,e.fileName?`${e.fileName}.html`:"stats.html"),p=r.processFoamModule(),d=await Q(p,{title:t,mode:"stat"});return ae.writeFile(l,d,"utf8")}case"server":{let l=r.processFoamModule(),{setup:p,port:d}=se((e.analyzerPort==="auto"?0:e.analyzerPort)??8888);if(p(l,{title:t,mode:"stat"}),(e.openAnalyzer??!0)&&!$e){let y=`http://localhost:${d}`;_e(y)}break}default:throw new Error("Invalidate Option `analyzerMode`")}}}}export{Ge as adapter,Qt as analyzer,Qt as default};
